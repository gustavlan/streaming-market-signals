version: 2

sources:
  - name: kworb
    schema: main
    tables:
      - name: raw_kworb_charts
        description: Daily Spotify chart data scraped from Kworb

  - name: python_models
    schema: main
    description: Tables created by Python scripts (not dbt models)
    tables:
      - name: dim_labels
        description: Label dimension with ultimate parent resolved via NetworkX graph traversal. Created by scripts/build_hierarchy.py
        columns:
          - name: label_id
            description: MusicBrainz label UUID
          - name: label_name
            description: Label name
          - name: ultimate_parent_name
            description: Name of the top-level parent in ownership chain
          - name: ownership_path
            description: Full path from label to ultimate parent
          - name: market_share_group
            description: "Classification: UMG, Sony, Warner, or Independent / Other"

models:
  - name: stg_musicbrainz_labels
    description: Staging layer for MusicBrainz labels with standardized column names
    columns:
      - name: label_id
        description: MusicBrainz label UUID
      - name: label_name
        description: Label name
      - name: relations
        description: JSON array of label relationships

  - name: stg_combined_charts
    description: Combined daily chart data from all Kworb parquet files
    columns:
      - name: chart_date
        description: Date of the chart
      - name: artist_name
        description: Artist name
      - name: track_name
        description: Track title
      - name: daily_streams
        description: Number of streams on this date

  - name: stg_track_metadata_normalized
    description: Track metadata with normalized label names for fuzzy matching
    columns:
      - name: spotify_track_id
        description: Spotify track ID
      - name: spotify_label
        description: Original label from Spotify
      - name: normalized_label
        description: Lowercased, punctuation-stripped label for matching

  - name: int_labels_normalized
    description: Intermediate model normalizing dim_labels for fuzzy matching to Spotify labels
    columns:
      - name: label_id
        description: MusicBrainz label UUID
      - name: label_name
        description: Original label name from MusicBrainz
      - name: ultimate_parent_name
        description: Top-level parent in ownership chain
      - name: market_share_group
        description: Parent group classification (UMG, Sony, Warner, Independent)
      - name: normalized_label
        description: Lowercased, punctuation-stripped label for fuzzy matching

  - name: int_label_relationships
    description: Flattened label-to-label relationships from MusicBrainz
    columns:
      - name: child_label_id
        description: Source label in the relationship
      - name: parent_label_id
        description: Target label in the relationship
      - name: relationship_type
        description: Type of relationship (label ownership, imprint, etc.)
      - name: direction
        description: MusicBrainz relationship direction (forward/backward)

  - name: int_charts_with_track_id
    description: Charts joined to Spotify track IDs via fuzzy matching
    columns:
      - name: chart_date
        description: Date of the chart
      - name: spotify_track_id
        description: Matched Spotify track ID
      - name: daily_streams
        description: Stream count

  - name: fact_market_share
    description: Incremental fact table aggregating daily streams by parent group
    columns:
      - name: chart_date
        description: Date of aggregation
        tests:
          - not_null
      - name: parent_group
        description: Market share group (UMG/Sony/Warner/Independent)
        tests:
          - not_null
          - accepted_values:
              values: ['Universal Music Group', 'Sony Music Entertainment', 'Warner Music Group', 'Independent / Other', 'Independent / Unmapped']
      - name: total_streams
        description: Sum of daily streams for this group
        tests:
          - not_null
      - name: track_count
        description: Distinct tracks in this group
        tests:
          - not_null
      - name: market_share_pct
        description: Percentage of total daily streams
        tests:
          - not_null
    tests:
      - unique:
          column_name: "chart_date || '-' || parent_group"
      - dbt_utils.expression_is_true:
          expression: "market_share_pct >= 0 AND market_share_pct <= 1"
          config:
            where: "market_share_pct IS NOT NULL"
